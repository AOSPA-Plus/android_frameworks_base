From b115fb5ae9d3c51754e32cac7ced30114383548d Mon Sep 17 00:00:00 2001
From: Kra1o5 <kra1o5x@gmail.com>
Date: Mon, 9 Nov 2020 15:57:18 +0100
Subject: [PATCH] Thinks

Change-Id: I871918779f012d6da5bcc9515fc5ff26a880ed67
---
 core/java/android/provider/Settings.java           |  6 ++++++
 .../statusbar/phone/NavigationModeController.java  | 14 ++++++++++----
 2 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/core/java/android/provider/Settings.java b/core/java/android/provider/Settings.java
index 1b285aaa204..2508c4e5b3d 100644
--- a/core/java/android/provider/Settings.java
+++ b/core/java/android/provider/Settings.java
@@ -9133,6 +9133,12 @@ public final class Settings {
         public static void setLocationProviderEnabled(ContentResolver cr,
                 String provider, boolean enabled) {
         }
+
+       /**
+         * Immersive Navigation gesture
+         * @hide
+         */
+        public static final String IMMERSIVE_NAVIGATION = "immersive_navigation";
     }
 
     /**
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationModeController.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationModeController.java
index c211de08cb8..fcf8503c363 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationModeController.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/NavigationModeController.java
@@ -59,6 +59,8 @@ public class NavigationModeController implements Dumpable {
     private static final String TAG = NavigationModeController.class.getSimpleName();
     private static final boolean DEBUG = true;
 
+    private static final String NAV_MODE_IMMERSIVE_OVERLAY = "co.aospa.overlay.systemui.immnav.gestural";
+
     public interface ModeChangedListener {
         void onNavigationModeChanged(int mode);
     }
@@ -131,8 +133,10 @@ public class NavigationModeController implements Dumpable {
     public void updateCurrentInteractionMode(boolean notify) {
         mCurrentUserContext = getCurrentUserContext();
         int mode = getCurrentInteractionMode(mCurrentUserContext);
+        boolean immnav = Settings.Secure.getInt(mCurrentUserContext.getContentResolver(),
+                Settings.Secure.IMMERSIVE_NAVIGATION, 1) == 1;
         if (mode == NAV_BAR_MODE_GESTURAL) {
-            switchToDefaultGestureNavOverlayIfNecessary();
+            switchToDefaultGestureNavOverlayIfNecessary(immnav);
         }
         mUiBgExecutor.execute(() ->
             Settings.Secure.putString(mCurrentUserContext.getContentResolver(),
@@ -187,18 +191,20 @@ public class NavigationModeController implements Dumpable {
         }
     }
 
-    private void switchToDefaultGestureNavOverlayIfNecessary() {
+    private void switchToDefaultGestureNavOverlayIfNecessary(boolean immnav) {
         final int userId = mCurrentUserContext.getUserId();
         try {
             final IOverlayManager om = IOverlayManager.Stub.asInterface(
                     ServiceManager.getService(Context.OVERLAY_SERVICE));
-            final OverlayInfo info = om.getOverlayInfo(NAV_BAR_MODE_GESTURAL_OVERLAY, userId);
+            final OverlayInfo info = om.getOverlayInfo(immnav ? NAV_MODE_IMMERSIVE_OVERLAY :
+                                                     NAV_BAR_MODE_GESTURAL_OVERLAY, userId);
             if (info != null && !info.isEnabled()) {
                 // Enable the default gesture nav overlay, and move the back gesture inset scale to
                 // Settings.Secure for left and right sensitivity.
                 final int curInset = mCurrentUserContext.getResources().getDimensionPixelSize(
                         com.android.internal.R.dimen.config_backGestureInset);
-                om.setEnabledExclusiveInCategory(NAV_BAR_MODE_GESTURAL_OVERLAY, userId);
+                om.setEnabledExclusiveInCategory(immnav ? NAV_MODE_IMMERSIVE_OVERLAY :
+                                               NAV_BAR_MODE_GESTURAL_OVERLAY, userId);
                 final int defInset = mCurrentUserContext.getResources().getDimensionPixelSize(
                         com.android.internal.R.dimen.config_backGestureInset);
 
-- 
2.25.1

